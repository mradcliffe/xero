language: php

php:
  - 5.6

env:
  - DRUPAL=8.1.x
  - DRUPAL=8.2.x
  - DRUPAL=8.3.x

matrix:
  allow_failures:
    - env: DRUPAL=8.3.x

sudo: false

install:
  - git config --global github.accesstoken $GITHUB_OAUTH_TOKEN

  # Try to make the git checkout not shallow because travis.
  - if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then git checkout -b "$TRAVIS_PULL_REQUEST" ; fi
  - rm .git/shallow

  # Download Drupal and dependencies.
  - TESTDIR=$(pwd)
  - cd ..
  - git clone --depth 1 --branch ${DRUPAL} http://git.drupal.org/project/drupal.git drupal
  - cd drupal

  # Add composer test dependencies to Drupal.
  - composer config repositories.drupal composer https://packages.drupal.org/8
  - composer config repositories.xero vcs $TESTDIR
before_script:
  # Figure out the branch or pull request branch to use.
  - COMPOSER_BRANCH=$TRAVIS_BRANCH
  - if [ "$TRAVIS_PULL_REQUEST" != "false" ] ; then COMPOSER_BRANCH=$TRAVIS_PULL_REQUEST ; fi

  # Require xero module.
  - composer require --prefer-source "drupal/xero:dev-${COMPOSER_BRANCH} as 1.x-dev"

  # Go back to repository directory to run phpunit.
  - cd modules/xero
script:
  - ../../vendor/bin/phpunit --coverage-text=$TRAVIS_BUILD_DIR/coverage.txt
after_script:
  # Print out coverage report.
  - head $TRAVIS_BUILD_DIR/coverage.txt
